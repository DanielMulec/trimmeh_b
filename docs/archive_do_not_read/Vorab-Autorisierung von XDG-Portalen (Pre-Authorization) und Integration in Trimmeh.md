# Vorab-Autorisierung von XDG-Portalen (Pre-Authorization) und Integration in Trimmeh

## Hintergrund: Portale und Berechtigungsabfragen in KDE/Plasma

Unter Wayland müssen Anwendungen für bestimmte Aktionen (z.B. Bildschirmfreigabe oder ferngesteuerte Eingaben) das **xdg-desktop-portal** verwenden. Dieses Portal zeigt normalerweise einen Bestätigungsdialog an, damit der Nutzer der App temporär die benötigte Berechtigung erteilen kann. Ein typisches Beispiel ist die **Remote-Desktop/Remote-Control Anfrage**: Wenn eine Anwendung Tastatur- und Mauseingaben auf dem System simulieren möchte (etwa für Fernsteuerung oder automatisiertes Einfügen von Text), erscheint ein Dialog *„Remote control requested“* bzw. *„Grant permission“*, den der Nutzer bestätigen muss. Standardmäßig geht diese Erlaubnis nach Beenden der Anwendung oder nach einem Neustart des Portals verloren – d.h. der Dialog würde bei jedem neuen Start erneut erscheinen[\[1\]](https://www.scribd.com/document/963329531/kde#:~:text=Xdg,and%20makes%20unattended%20access%20impossible). Das macht unbeaufsichtigte oder automatisierte Nutzung schwierig.

**Pre-Authorization** (Vorab-Autorisierung) wurde eingeführt, um dieses Problem zu lösen. Seit **KDE Plasma 6.3** gibt es die Möglichkeit, bestimmten Apps im Voraus dauerhafte Portal-Rechte zu gewähren, sodass interaktive Nachfragen entfallen[\[2\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Interactive%20permission%20prompts%20are%20nice%2C,interactively). Mit anderen Worten: Man kann eine Anwendung *whitelisten*, damit sie z.B. ferngesteuerte Eingaben ohne jedes Mal nachzufragen durchführen darf. Diese Vorab-Berechtigungen werden im **XDG-Permission-Store** (dem Berechtigungsspeicher des Portals) hinterlegt.

## Funktionsweise der Pre-Authorization (XDG-Permission-Store)

KDE Plasma 6.3 hat eine spezielle Berechtigungstabelle namens `kde-authorized` im XDG-Permission-Store eingeführt[\[3\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command). In dieser Tabelle können permanent gespeicherte **Ausnahmeregeln** abgelegt werden, die die üblichen Portal-Abfragen überschreiben. Derzeit unterstützt KDE hiermit hauptsächlich die **Remote-Desktop**-Funktion (Tastatur/Maus-Eingaben aus der Ferne)[\[4\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Supported%20Types) – weitere Portal-Typen könnten in Zukunft folgen. Die Idee ist: Steht in der Tabelle, dass App *XYZ* für *remote-desktop* *„yes“* (erlaubt) hat, dann lässt das Portal diese Anfrage von App XYZ automatisch durch, **ohne** den Nutzer zu belästigen[\[2\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Interactive%20permission%20prompts%20are%20nice%2C,interactively).

**Eintragen einer Vorab-Erlaubnis:** Die Verwaltung dieser Berechtigungstabelle erfolgt aktuell über die Flatpak-Kommandozeile. Dazu verwendet man den Befehl [`flatpak permission-set`](https://docs.flatpak.org/en/latest/flatpak-command-reference.html#flatpak-permission-set), mit dem man einen Eintrag setzen kann. Die allgemeine Syntax lautet:

    flatpak permission-set kde-authorized <Portal-Typ> <App-ID> yes

- `kde-authorized` – die Tabelle für Vorab-Autorisierungen in KDE.
- `<Portal-Typ>` – z.B. `remote-desktop` für ferngesteuerte Eingabe (Remote Control).
- `<App-ID>` – die Anwendungskennung, für die die Ausnahme gelten soll.
- `yes` – der Wert, der angibt, dass Zugriff erlaubt ist (analog zu *true*).

Beispiel: Um der bekannten Anwendung *KRdpServer* im Voraus Remote-Desktop-Rechte zu gewähren, würde man folgendes ausführen[\[3\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command):

    flatpak permission-set kde-authorized remote-desktop org.kde.krdpserver yes

Nach dem Eintrag einer solchen Regel *sollte der entsprechende Portal-Dialog für diese App nicht mehr erscheinen*, da das Portal die Berechtigung nun automatisch erteilt[\[5\]](https://www.scribd.com/document/963329531/kde#:~:text=authorization%20is%20lost%20after%20the,and%20makes%20unattended%20access%20impossible). Wichtig ist, dass die Anwendung dabei vom Portal **als diese App-ID erkannt** wird – dazu gleich mehr.

> **Nicht-Flatpak-Apps:** Obwohl der Befehl über `flatpak` erfolgt, muss die Anwendung **nicht als Flatpak-Paket** laufen, um vorab autorisiert zu werden[\[6\]](https://www.scribd.com/document/963329531/kde#:~:text=applications,authorized). Die Flatpak-CLI dient hier lediglich als Werkzeug, um den XDG-Permission-Store zu manipulieren (sie wird oft mitinstalliert, da Flatpak zunehmend verbreitet ist). Das Portal selbst ist systemweit aktiv, auch für normale (unsandboxed) Programme. Voraussetzung ist allerdings, dass das **xdg-desktop-portal** und sein KDE-Backend (`xdg-desktop-portal-kde`) installiert und in Betrieb sind – was in einer Plasma-Wayland-Session normalerweise gegeben ist.

**Ermittlung der Application-ID:** Um eine Anwendung einzutragen, benötigt man ihre **App-ID** (Application Identifier). Bei Flatpak-Apps ist das die im Flatpak-Metadaten hinterlegte ID (z.B. `org.gnome.App`). Bei normalen Desktop-Programmen ergibt sich die App-ID wie folgt:

- **Start über Plasma Desktop/KRunner:** Wird die App über eine `.desktop`-Datei gestartet (Menü, KRunner, Autostart), setzt Plasma automatisch die App-ID auf den Namen der Desktop-Datei. In der Regel entspricht das dem Dateinamen ohne Endung, z.B. `org.kde.krdpserver.desktop` → App-ID `org.kde.krdpserver`[\[7\]](https://www.scribd.com/document/963329531/kde#:~:text=ssions%2F%29%20and%20flatpak,file%20under%20%2Fusr%2Fshare%2Fapplications).
- **Systemd-User-Service:** Wenn die App als Systemd-Dienst im Nutzerkontext läuft, sollte der Dienstname dem Schema `app-<AppID>.service` folgen (gemäß \[systemd Spezifikation\]\[201\]). Beispielsweise hätte ein Dienst `app-lan-mouse.service` die App-ID `lan-mouse`[\[8\]](https://www.scribd.com/document/963329531/kde#:~:text=If%20you%20start%20it%20as,name%20of%20that%20unit%20instead).
- **Manuell gestartete Apps ohne ID:** Programme, die keine App-ID mitbringen und nicht über Plasma/Service gestartet wurden, werden vom Portal als *namenslos* angesehen. In solchen Fällen kann man als Platzhalter eine **leere App-ID** `""` angeben, wodurch die Regel **für alle unsandboxed Anwendungen** greift[\[9\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20authorize%20a%20host%20application,may%20be%20provided)[\[10\]](https://www.scribd.com/document/963329531/kde#:~:text=If%20you%20application%20does%20not,can%20leave%20that%20field%20empty). Dies ist jedoch ein grober Vorschlaghammer und **aus Sicherheitsgründen nicht empfohlen**, da damit praktisch jede beliebige Anwendung diese Portalrechte bekäme[\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=,portal%20using%20the%20Registry%20system). Idealerweise sorgt man dafür, dass die konkrete Anwendung eine eindeutige ID setzt, und verwendet diese.

Zusammengefasst sind die Schritte für eine manuelle Pre-Authorization:

1.  **Application-ID ermitteln:** Sicherstellen, dass man die richtige App-ID der Anwendung kennt (z.B. durch Nachschauen des Desktop-Dateinamens unter `/usr/share/applications` oder `~/.local/share/applications`).
2.  **Berechtigung setzen:** Den `flatpak permission-set ... yes` Befehl mit `kde-authorized`, dem Portaltyp und der App-ID ausführen. (Gegebenenfalls vorher Flatpak installieren, falls nicht vorhanden.)
3.  **Wirkung prüfen:** Beim nächsten Start bzw. bei der nächsten Portal-Anfrage der Anwendung sollte kein Bestätigungsdialog mehr auftauchen, da die Berechtigung nun dauerhaft gewährt ist.

Eine einmal gesetzte Vorab-Autorisierung bleibt persistent gespeichert. Sie lässt sich bei Bedarf mit einem ähnlichen Befehl auch wieder entfernen oder ändern (z.B. via `flatpak permission-remove` oder künftig über eine GUI). Ab **Plasma 6.5** gibt es nämlich eine Einstellungsseite, in der man Anwendungsberechtigungen verwalten kann – inklusive der KDE-spezifischen Remote-Control-Ausnahme[\[12\]](https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/#:~:text=grant%20permission%20to%20the%20app,you%20can%20configure%20application%20permissions)[\[13\]](https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/#:~:text=Finally%20you%20can%20configure%20screen,can%20also%20be%20enabled%20here). In Plasma 6.3/6.4 erfolgt die Konfiguration hingegen ausschließlich über die Kommandozeile.

## Pre-Authorization in Trimmeh (Integration für eine Nicht-Flatpak-App)

**Trimmeh-KDE** ist eine native KDE/Plasma-Anwendung (keine Flatpak-Sandbox), die unter anderem die **RemoteDesktop-Portal**-Schnittstelle nutzt, um unter Wayland Tastatureingaben zu simulieren. Konkret ermöglicht Trimmeh das automatisierte **Einfügen von Text aus der Zwischenablage** (als "Paste" Funktion) via künstlichem `Ctrl+V` bzw. `Shift+Insert` – hierfür wird im Hintergrund eine Remote-Desktop-Portal-Session gestartet, um die Eingabeereignisse ans System zu schicken[\[14\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34)[\[15\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L289-L298).

Ohne Vorab-Autorisierung führt Trimmeh’s erster Versuch, Tastatureingaben zu injizieren, zum bekannten **„Grant Permission“**-Dialog, in dem der Benutzer einmalig die Remote-Control-Berechtigung für Trimmeh erlauben muss. Trimmeh versucht bereits, die Zustimmung nach Möglichkeit **persistieren** zu lassen: Es setzt `persist_mode = 2 (persistent)` und speichert ein erhaltenes `restore_token`, um eine einmal erteilte Erlaubnis beim nächsten Start wiederverwenden zu können[\[16\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L349-L357)[\[17\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L353-L361). Allerdings war vor Plasma 6.3 diese Persistenz nicht zuverlässig über App-Neustarts hinweg – daher die neue Lösung mit dem Permission-Store.

Um Pre-Authorization für Trimmeh zu nutzen, geht man wie oben beschrieben vor, speziell mit Trimmehs App-ID. Die Entwickler von Trimmeh haben dafür gesorgt, dass die Anwendung eine **feste Application-ID** besitzt: `dev.trimmeh.TrimmehKDE`. Beim ersten Start schreibt Trimmeh eine Desktop-Datei `dev.trimmeh.TrimmehKDE.desktop` in das Benutzer-Verzeichnis (`~/.local/share/applications`) und registriert sich beim Portal unter dieser ID[\[18\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L32-L40)[\[19\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L112-L120). Dadurch wird sichergestellt, dass das Portal Trimmeh eindeutig erkennen kann und die Berechtigung *auf diese App begrenzt* werden kann[\[14\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34).

**Vorab-Berechtigung für Trimmeh erteilen:** Hat man Plasma 6.3 oder höher und das Portal im Einsatz, kann man nun folgende Autorisierung setzen:

    flatpak permission-set kde-authorized remote-desktop dev.trimmeh.TrimmehKDE yes

Dadurch wird der Application-ID **dev.trimmeh.TrimmehKDE** dauerhaft das Recht eingeräumt, das Remote-Desktop-Portal (hier speziell die Tastatur/Maus-Eingabe) zu nutzen, **ohne weitere Nachfragen**[\[3\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command). Mit diesem Eintrag im XDG-Permission-Store sollte der *“Grant Permission”*-Dialog beim Einfügen über Trimmeh **nicht mehr erscheinen**, da das Portal die Anfrage nun automatisch genehmigt[\[5\]](https://www.scribd.com/document/963329531/kde#:~:text=authorization%20is%20lost%20after%20the,and%20makes%20unattended%20access%20impossible). Praktisch bedeutet das, dass Trimmeh ab dem nächsten Start sofort ferngesteuerte Tastatureingaben vornehmen kann, ohne dass der Benutzer jedes Mal interaktiv zustimmen muss.

Ein paar Punkte sind zu beachten:

- **Flatpak-CLI erforderlich:** Wie erwähnt benötigt dieser Schritt das Flatpak-Werkzeug. Auf den meisten KDE-Systemen, die Flatpaks oder das Portal verwenden, ist `flatpak` oft schon installiert. Falls nicht, müsste man es nachinstallieren oder – weniger schön – den Workaround mit leerer App-ID nutzen (`""`), was aber **nicht ratsam** ist[\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=,portal%20using%20the%20Registry%20system). Es lohnt sich, Flatpak allein für die Berechtigungssteuerung zu verwenden, da dies sauber auf eine App begrenzt werden kann.
- **Korrekte App-ID verwenden:** Achten Sie darauf, genau **dev.trimmeh.TrimmehKDE** als ID zu verwenden (Groß-/Kleinschreibung beachten). Diese muss mit der Desktop-Datei und der Registrierung übereinstimmen. Falls man Trimmeh ausnahmsweise ohne Desktop-Datei startet und die ID nicht greift, könnte die Vorab-Regel eventuell nicht ziehen – aber dank der internen Registrierung in Trimmeh ist das normalerweise abgedeckt[\[19\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L112-L120).
- **Sicherheit:** Die Vorab-Autorisierung sollte nur für vertrauenswürdige Anwendungen gesetzt werden. Da unsandboxed Apps theoretisch jede App-ID beanspruchen könnten, sollte man keine fremde ID freischalten, die vielleicht missbraucht werden könnte[\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=,portal%20using%20the%20Registry%20system). Im Fall von Trimmeh hat man Kontrolle über die Software, sodass dieses Risiko überschaubar ist. Es wird auch empfohlen, *nicht* den generellen Platzhalter `""` zu verwenden, da dies **allen** nicht-sandboxed Programmen die Remote-Control-Rechte geben würde[\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=,portal%20using%20the%20Registry%20system).

## Fazit

Die **Pre-Authorization** des Remote-Desktop-Portals ist ein mächtiges Feature, um die Benutzererfahrung bei Tools wie Trimmeh zu verbessern. Zusammengefasst erlaubt es, **bestimmten Anwendungen im Voraus Portalrechte zu gewähren**, sodass kein wiederholter Eingriff des Nutzers nötig ist. In KDE Plasma ab 6.3 ist dies über die `kde-authorized`-Tabelle im XDG-Permission-Store möglich[\[2\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Interactive%20permission%20prompts%20are%20nice%2C,interactively). Für Trimmeh, das als Systemanwendung läuft, bedeutet dies konkret: einmalig den oben genannten Flatpak-Befehl mit der Trimmeh-App-ID ausführen, und fortan sind ferngesteuerte Paste-Vorgänge ohne Nachfragen möglich.

Diese Lösung ist insbesondere in geskripteten oder automatisierten Umgebungen hilfreich, wo keine Benutzerinteraktion erfolgen soll. Beachten sollte man jedoch immer die Implikationen für die Sicherheit – Vorab-Autorisierung umgeht bewusst die Schutzmechanismen, daher sparsam und gezielt einsetzen (und nur für Tools, denen man voll vertraut). Mit Plasma 6.5 wird die Verwaltung solcher Berechtigungen noch komfortabler über die Systemsettings möglich sein[\[12\]](https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/#:~:text=grant%20permission%20to%20the%20app,you%20can%20configure%20application%20permissions); bis dahin ist die manuelle Einrichtung, wie oben beschrieben, der Weg zum Ziel.

**Quellen:** Die obigen Informationen basieren auf der KDE-Entwicklerdokumentation und offiziellen Wiki-Einträgen[\[2\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Interactive%20permission%20prompts%20are%20nice%2C,interactively)[\[20\]](https://www.scribd.com/document/963329531/kde#:~:text=applications,authorized) sowie Einsichten aus Trimmehs Code und Dokumentation[\[14\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34)[\[18\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L32-L40), die die Implementierung der Portal-Anbindung erläutern. Viel Erfolg bei der Integration von Pre-Authorization in Trimmeh!

------------------------------------------------------------------------

[\[1\]](https://www.scribd.com/document/963329531/kde#:~:text=Xdg,and%20makes%20unattended%20access%20impossible) [\[5\]](https://www.scribd.com/document/963329531/kde#:~:text=authorization%20is%20lost%20after%20the,and%20makes%20unattended%20access%20impossible) [\[6\]](https://www.scribd.com/document/963329531/kde#:~:text=applications,authorized) [\[7\]](https://www.scribd.com/document/963329531/kde#:~:text=ssions%2F%29%20and%20flatpak,file%20under%20%2Fusr%2Fshare%2Fapplications) [\[8\]](https://www.scribd.com/document/963329531/kde#:~:text=If%20you%20start%20it%20as,name%20of%20that%20unit%20instead) [\[10\]](https://www.scribd.com/document/963329531/kde#:~:text=If%20you%20application%20does%20not,can%20leave%20that%20field%20empty) [\[20\]](https://www.scribd.com/document/963329531/kde#:~:text=applications,authorized) kde \| PDF \| Desktop Environment \| Window Manager

<https://www.scribd.com/document/963329531/kde>

[\[2\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Interactive%20permission%20prompts%20are%20nice%2C,interactively) [\[3\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command) [\[4\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=Supported%20Types) [\[9\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20authorize%20a%20host%20application,may%20be%20provided) [\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=,portal%20using%20the%20Registry%20system) XDG Portal Pre-Authorization \| Developer

<https://develop.kde.org/docs/administration/portal-permissions/>

[\[12\]](https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/#:~:text=grant%20permission%20to%20the%20app,you%20can%20configure%20application%20permissions) [\[13\]](https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/#:~:text=Finally%20you%20can%20configure%20screen,can%20also%20be%20enabled%20here) English - Planet KDE

<https://planet.kde.org/david-redondo-2025-09-04-configuring-portal-permissions-in-plasma/>

[\[14\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34) kde-klipper-plan.md

<https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md>

[\[15\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L289-L298) [\[16\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L349-L357) [\[17\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L353-L361) [\[18\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L32-L40) [\[19\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L112-L120) portal_paste_injector.cpp

<https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp>
