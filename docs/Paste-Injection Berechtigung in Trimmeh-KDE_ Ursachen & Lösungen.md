# Paste-Injection Berechtigung in Trimmeh-KDE: Ursachen & Lösungen

## Verwendete Portale und Mechanismen

Die KDE-Version der App *Trimmeh* nutzt für das Einfügen von Text per Hotkey die **Freedesktop XDG Desktop Portal**-Schnittstelle für Remote Desktop (speziell Keyboard-Input). Konkret wird über D-Bus das Interface `org.freedesktop.portal.RemoteDesktop` des **xdg-desktop-portal** angesprochen, um Tastendrücke (z. B. `Shift+Insert` bzw. simuliert `Ctrl+V`) an das fokussierte Fenster zu senden[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34). Der Code registriert dabei eine **stabile Application-ID** (`dev.trimmeh.TrimmehKDE`) beim Portal (über `org.freedesktop.host.portal.Registry`) und erzeugt eine passende `.desktop`-Datei, damit das Portal die Anwendung eindeutig erkennen kann[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34)[\[2\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L216-L221). Diese `.desktop`-Datei wird unter `~/.local/share/applications/dev.trimmeh.TrimmehKDE.desktop` abgelegt und enthält u. a. den ausführbaren Pfad der App[\[3\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L76-L84). Durch die Registrierung der App-ID und die Nutzung des RemoteDesktop-Portals stellt Trimmeh-KDE sicher, dass die **Eingabe-Injektion** den Sicherheitsrichtlinien von Wayland entspricht, da direkte Fake-Key-Events unter Wayland ohne Portal nicht erlaubt sind.

## Wiederholte Berechtigungsabfrage: Ursache

Obwohl die Implementierung vorsieht, dass die Berechtigung **persistent** gespeichert wird, muss der Nutzer unter KDE derzeit bei jedem Start erneut den Zugriff erlauben. Die App fordert über das Portal zunächst eine **RemoteDesktop-Session** mit Tastaturzugriff an (`SelectDevices` mit `types = keyboard`) und setzt dabei `persist_mode = 2` (dauerhafte Berechtigung bis zum Widerruf)[\[4\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L350-L358). Nach einer Zustimmung durch den Nutzer liefert das Portal einen `restore_token`, den Trimmeh-KDE abspeichert, um ihn beim nächsten Start wieder zu verwenden[\[5\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L472-L479). **In der Praxis zeigt KDE jedoch trotzdem jedes Mal den Bestätigungsdialog** („Remote Control Requested“ bzw. „Grant Permission“) erneut an, anstatt die vorige Erlaubnis wiederzuverwenden.

Der Grund dafür liegt höchstwahrscheinlich **nicht in Trimmeh selbst**, sondern in der aktuellen Umsetzung der Portale unter KDE/Plasma: - **Fehlende persistente Speicherung:** Die Freedesktop-Portalspezifikation (RemoteDesktop **Version 2**) unterstützt zwar persistenten Zugriff, aber zum Zeitpunkt von Plasma 6.5 scheint die Umsetzung noch unvollständig. Es gibt Hinweise aus der Community, dass sowohl das Portal selbst als auch die Wayland-Compositoren (z. B. KWin bei KDE) noch Änderungen benötigen, damit eine einmal erteilte Erlaubnis nicht bei jeder neuen Session erneut erfragt wird[\[6\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=,portal%231186). Ein Feature-Request hierzu beschreibt genau dieses Problem: *“Das Portal-Dialogfenster erscheint jedes Mal, wenn … Input Capture benötigt wird. … Benutzer möchten, dass der Dialog nur einmal gezeigt wird.”*[\[7\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=The%20Capture%20Input%20XDG%20Desktop,dialog%20to%20show%20only%20once). Dies deutet darauf hin, dass die derzeitige Portal-Implementierung die Zustimmung nicht dauerhaft speichert, zumindest nicht für Remote-Desktop/Keyboard-Zugriff.  
- **Sicherheitsdesign von KDE:** KDE Plasma könnte aus Sicherheitsgründen (noch) keine automatische **Persistierung von Eingabe-Berechtigungen** vornehmen. Bis vor kurzem gab es keine komfortable Möglichkeit, einer unsandboxed-Anwendung dauerhaft das Recht zu geben, globale Eingaben zu steuern. Jede neue Portal-Anfrage wird vom **xdg-desktop-portal-kde** Backend in Zusammenarbeit mit KWin neu bestätigt. Erst mit neueren Plasma-Versionen (siehe unten) wurden Mechanismen eingeführt, um vertrauenswürdigen Anwendungen Vorab-Berechtigungen zu erteilen.  
- **Kein Konfigurationsfehler:** Es handelt sich wahrscheinlich **weder um einen Implementierungsfehler in Trimmeh-KDE noch um eine falsche Einstellung auf Nutzerseite**, sondern um eine Limitierung/fehlendes Feature der aktuellen Portal- bzw. KDE-Infrastruktur. Der Code von Trimmeh-KDE hält sich an die vorgesehenen APIs (App-ID registrieren, Persistenz-Flag setzen, Token speichern)[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34)[\[4\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L350-L358), jedoch greift die gewünschte Persistenz unter KDE noch nicht wie erwartet.

## Standardkonformität und Rolle von *xdg-desktop-portal-kde*

Die Anbindung von Trimmeh-KDE an das Portal erfolgt **standardkonform**. Es werden die offiziellen D-Bus-Methoden der Portal-API genutzt: Zuerst `CreateSession`, dann `SelectDevices` (für die Tastatur, inkl. Persist-Option) und schließlich `Start` der Session[\[8\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L349-L358)[\[9\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L381-L390). Die App meldet sich ordnungsgemäß mit ihrer Application-ID beim Portal an[\[2\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L216-L221) und erfüllt damit die Voraussetzung, dass ein passender Desktop-Eintrag existiert[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34). Aus Sicht der Freedesktop-Spezifikation macht Trimmeh-KDE also alles richtig.

Unter KDE übernimmt **xdg-desktop-portal-kde** die Anfrage und präsentiert den grafischen Bestätigungsdialog. Dieses Backend vermittelt zwischen der allgemeinen Portal-Schnittstelle und dem **KWin Compositor**. Wenn eine Anwendung (hier Trimmeh-KDE) via Portal Keyboard-Steuerung anfordert, zeigt xdg-desktop-portal-kde das Dialogfenster *„Fernsteuerung angefordert“* an, in dem der Nutzer die Eingabesteuerung erlauben oder ablehnen kann. **KWin** selbst erlaubt die Einblendung fremder Tastendrücke nur, wenn die Portal-Bestätigung vorliegt. Momentan behandelt KWin/jedes neue Portal-Session als eigenständigen Vorgang, weshalb trotz vorhandener App-ID und Token kein automatisches „Erinnern“ erfolgt. Es ist ein bekanntes Problem, dass diese **Persistenz-Funktion** noch nicht vollständig umgesetzt ist – entsprechende Änderungen in xdg-desktop-portal und KWin sind in Arbeit (teils sogar mit Bug-Bounties versehen)[\[6\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=,portal%231186). Kurz gesagt: Die aktuelle Portal-Implementierung unter KDE erzwingt aus Sicherheitsgründen bei jeder neuen Programmsitzung einen erneuten **Grant Permission**-Dialog, unabhängig davon, ob die Anwendung sich an die API-Konventionen hält.

## Empfehlungen zur Verbesserung des Verhaltens

Um die Situation zu verbessern und zu verhindern, dass bei jedem Start die Berechtigung neu erteilt werden muss, gibt es folgende Ansätze:

- **Portal-Versionsupdate / Plasma-Upgrade:** Stellen Sie sicher, dass Sie die **neueste Version** von xdg-desktop-portal und Plasma/KDE installiert haben. Verbesserungen an der *Persistenz von RemoteDesktop-Berechtigungen* sind in neueren Releases zu erwarten. Beobachten Sie die Entwicklung der entsprechenden Portal-Features. Sobald die Upstream-Patches in xdg-desktop-portal und KWin einfließen, sollte eine einmal erteilte Erlaubnis tatsächlich über Neustarts hinaus gespeichert bleiben[\[6\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=,portal%231186). In Plasma 6.5 (Stand Ende 2025) ist dies noch im Fluss, aber kommende Versionen könnten das Verhalten ändern.

- **Manuelle Vorab-Autorisierung (Pre-Authorization):** KDE bietet seit Plasma 6.3 eine Möglichkeit, bestimmten Anwendungen **vorab Portal-Rechte einzuräumen**, um interaktive Dialoge zu umgehen[\[10\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command). Über die Kommandozeile können Sie Trimmeh-KDE in den XDG-Permission-Store eintragen. Zum Beispiel:

<!-- -->

- flatpak permission-set kde-authorized remote-desktop dev.trimmeh.TrimmehKDE yes

  Mit diesem Befehl wird der Application-ID `dev.trimmeh.TrimmehKDE` dauerhaft das Recht eingeräumt, das Remote-Desktop-Portal (hier speziell `remote-desktop` für Tastatur/Maus) zu nutzen, **ohne Nachfragen**[\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=flatpak%20permission,yes). Nach dem Setzen dieser Berechtigung sollte der “Grant Permission”-Dialog nicht mehr erscheinen. *(Hinweis: Dies setzt voraus, dass* `flatpak` *bzw. das Portal-Permission-Store-Tool verfügbar ist. Alternativ kann man auch mit leerem App-ID (*`""`*) alle unsandboxed Apps für remote-desktop freischalten, was aber aus Sicherheitsgründen nicht empfohlen ist.)*

<!-- -->

- **Alternative ohne Portal unter X11:** Falls Sie Trimmeh-KDE in einer **X11-Session** nutzen, könnte man theoretisch die Portal-Abfrage umgehen, indem man anstelle des Portals direkt X11-Mechanismen zum Simulieren von Tastendrücken verwendet (z. B. XTest-Extension). Unter X11 bestehen keine vergleichbaren Beschränkungen wie unter Wayland, so dass eine solche Implementierung keine Nutzerbestätigung erfordern würde. Allerdings unterstützt die aktuelle Implementierung dies nicht – sie verwendet immer das Portal. Für rein X11-Nutzer könnte es dennoch eine Überlegung wert sein, in zukünftigen Versionen einen **X11-Fallback** einzubauen, um die Benutzerfreundlichkeit zu erhöhen. Unter Wayland bleibt das Portal aus Sicherheitsgründen alternativlos.

- **Überprüfung der App-Identität:** Achten Sie darauf, dass die **Desktop-Datei** korrekt installiert ist. In Trimmeh-KDE wird die Datei bereits im Nutzerverzeichnis erstellt[\[3\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L76-L84). Sollte das Portal die Anwendung dennoch als unbekannt einstufen, könnte man testweise die Desktop-Datei nach `/usr/share/applications/` kopieren oder ihren Inhalt auf Vollständigkeit prüfen (Name, Exec-Pfad etc.). In der Regel genügt die vorhandene `dev.trimmeh.TrimmehKDE.desktop`, um die App-ID bekannt zu machen[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34). Persistiert die Erlaubnis trotzdem nicht, liegt das Problem wie gesagt nicht an der App-ID, sondern an der generellen Portal-Behandlung.

Zusammenfassend ist die wiederholte “Grant Permission”-Abfrage beim Start von Trimmeh-KDE ein **KDE/Portal-spezifisches Verhalten**. Die Anwendung verwendet bereits die vorgesehenen Schnittstellen korrekt, aber die dauerhafte Speicherung der Berechtigung wird vom System (noch) nicht gewährleistet. Bis dieses Feature vollständig implementiert ist, können Sie entweder bei jedem Start manuell die Erlaubnis geben, die oben genannte **Pre-Authorization** durchführen oder – sofern verfügbar – auf zukünftige Plasma-Versionen mit verbessertem Berechtigungsmanagement upgraden. Dadurch sollten die Hotkeys zur Zwischenablagen-Injektion künftig ohne wiederholte Nachfragen funktionieren.

**Quellen:** Die Analyse basiert auf dem Quellcode von *DanielMulec/trimmeh_b* (Ordner `trimmeh-kde`)[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34)[\[4\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L350-L358) sowie offiziellen Dokumentationen und Diskussionen zum XDG-Portal unter KDE[\[7\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=The%20Capture%20Input%20XDG%20Desktop,dialog%20to%20show%20only%20once)[\[6\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=,portal%231186).

------------------------------------------------------------------------

[\[1\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md#L30-L34) kde-klipper-plan.md

<https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/docs/kde-klipper-plan.md>

[\[2\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L216-L221) [\[3\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L76-L84) [\[4\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L350-L358) [\[5\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L472-L479) [\[8\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L349-L358) [\[9\]](https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp#L381-L390) portal_paste_injector.cpp

<https://github.com/DanielMulec/trimmeh_b/blob/0a1ea6deb74821e3a5832a975874530ebbd39030/trimmeh-kde/src/portal_paste_injector.cpp>

[\[6\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=,portal%231186) [\[7\]](https://github.com/deskflow/deskflow/issues/8032#:~:text=The%20Capture%20Input%20XDG%20Desktop,dialog%20to%20show%20only%20once) Persist Input Capture XDG Desktop Portal dialog (Wayland) · Issue \#8032 · deskflow/deskflow · GitHub

<https://github.com/deskflow/deskflow/issues/8032>

[\[10\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=To%20solve%20this%2C%20we%20have,to%20the%20set%20command) [\[11\]](https://develop.kde.org/docs/administration/portal-permissions/#:~:text=flatpak%20permission,yes) XDG Portal Pre-Authorization \| Developer

<https://develop.kde.org/docs/administration/portal-permissions/>
